<!DOCTYPE html>
<html>
<head>
    <title>Go/No-Go Visual Search Task</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        #jspsych-content {
            width: 1024px;
            height: 768px;
            background: white;
            position: relative;
            border: 2px solid #333;
        }
        .trial-screen {
            text-align: center;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        .trial-screen.start-screen, .trial-screen.instructions, .trial-screen.end-screen {
            padding: 50px;
        }
        .stimulus {
            position: absolute;
            transform: translate(-50%, -50%);
        }
        .button {
            background-color: #4CAF50;
            border: none;
            color: white;
            padding: 15px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
        }
        .button:hover { background-color: #45a049; }
        .hidden { display: none; }
        .fixation {
            font-size: 48px;
            color: #333;
        }
        .input-field {
            margin: 10px 0;
            padding: 8px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 16px;
            width: 100px;
            text-align: center;
        }
        .label {
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
</head>
<body>
    <div id="jspsych-content">
        <div id="start-screen" class="trial-screen start-screen">
            <h1>Go/No-Go Visual Search Task</h1>
            <p>You will see stimuli in 4 quadrants on the screen.</p>
            <div style="margin: 20px 0;">
                <span class="label">Number of Trials:</span>
                <input type="number" id="trial-count" class="input-field" value="20" min="1" max="200">
            </div>
            <p>Press the button below when you're ready to begin.</p>
            <button class="button" onclick="startExperiment()">Start</button>
        </div>
        
        <div id="instructions" class="trial-screen instructions hidden">
            <h2>Instructions</h2>
            <p><strong>Go Trial:</strong> You will see 3 distractor stimuli and 1 target stimulus.</p>
            <p>Press the <strong>SPACEBAR</strong> when you see the target stimulus.</p>
            <br>
            <p><strong>No-Go Trial:</strong> You will see 4 distractor stimuli.</p>
            <p>Do <strong>NOT</strong> press any key.</p>
            <br>
            <p>Each trial starts with a blank screen, then the stimuli appear.</p>
            <button class="button" onclick="startBlock1()">Start Block 1</button>
        </div>
        
        <div id="trial-screen" class="trial-screen hidden">
            <div id="fixation" class="fixation">+</div>
            <div id="stimuli-container" style="position: relative; width: 100%; height: 100%;">
            </div>
        </div>
        
        <div id="end-screen" class="trial-screen end-screen hidden">
            <h2>Experiment Complete!</h2>
            <p>Thank you for participating.</p>
            <div id="data-summary"></div>
        </div>
    </div>

    <script>
        // Experiment data
        let experimentData = {
            startTime: null,
            endTime: null,
            blocks: [],
            currentBlock: 1,
            currentTrial: 0,
            totalTrials: 20,
            quadrantReactionTimes: {
                'upper_left': [],
                'upper_right': [],
                'lower_left': [],
                'lower_right': []
            }
        };
        
        // Stimulus pools for 4 groups
        let stimulusPools = {
            group1: [],
            group2: [],
            group3: [],
            group4: []
        };
        
        // Block configuration - easily change which groups are target vs distractor
        const blockConfig = {
            block1: {
                distractorGroup: 'group4',  // Most prevalent stimuli (3 per trial)
                targetGroup: 'group3'        // Target stimuli (1 per go trial)
            },
            block2: {
                distractorGroup: 'group1',  // Change these for different blocks
                targetGroup: 'group2'
            }
            // Add more blocks as needed
        };
        
        const settings = {
            blankDuration: 500,
            stimulusDuration: 3000,
            stimulusWidth: 310, // Width in pixels for stimuli
            jitterRange: 50,
            // True center of each quadrant in 1024x768 canvas
            quadrantCenters: {
                'upper_left': {x: 256, y: 192},
                'upper_right': {x: 768, y: 192},
                'lower_left': {x: 256, y: 576},
                'lower_right': {x: 768, y: 576}
            }
        };
        
        // Load stimulus pools for all 4 groups
        async function loadStimulusPools() {
            try {
                const groups = ['group1', 'group2', 'group3', 'group4'];
                
                for (const group of groups) {
                    try {
                        // Read the index.txt file instead of browsing directory
                        const response = await fetch(`stimuli/${group}/index.txt`);
                        if (response.ok) {
                            const text = await response.text();
                            const filenames = text.trim().split('\n').filter(name => name.endsWith('.png'));
                            stimulusPools[group] = filenames.map(filename => `stimuli/${group}/${filename}`);
                        }
                    } catch (error) {
                        console.log(`Error loading ${group}:`, error);
                    }
                }
                
                console.log('Loaded stimuli pools:', stimulusPools);
                
                // Check if any stimuli were loaded
                const totalStimuli = Object.values(stimulusPools).reduce((sum, pool) => sum + pool.length, 0);
                if (totalStimuli === 0) {
                    console.log('No PNG stimuli found, using fallback circles');
                    return false;
                }
                
                return true;
            } catch (error) {
                console.log('Error loading stimuli, using fallback circles:', error);
                return false;
            }
        }
        
        // Get random stimulus from specified group
        function getRandomStimulus(group) {
            const pool = stimulusPools[group];
            if (pool && pool.length > 0) {
                return pool[Math.floor(Math.random() * pool.length)];
            }
            return null; // Will fall back to circles
        }
        
        function startExperiment() {
            // Get trial count from input
            const trialCount = parseInt(document.getElementById('trial-count').value);
            if (trialCount < 1 || trialCount > 200) {
                alert('Please enter a valid number of trials (1-200)');
                return;
            }
            
            experimentData.totalTrials = trialCount;
            experimentData.startTime = new Date().toISOString();
            
            document.getElementById('start-screen').classList.add('hidden');
            document.getElementById('instructions').classList.remove('hidden');
        }
        
        async function startBlock1() {
            document.getElementById('instructions').classList.add('hidden');
            document.getElementById('trial-screen').classList.remove('hidden');
            
            // Load stimuli
            const stimuliLoaded = await loadStimulusPools();
            if (!stimuliLoaded) {
                alert('No stimulus images found. Please add PNG files to stimuli/group1/, stimuli/group2/, stimuli/group3/, and stimuli/group4/ folders.');
                return;
            }
            
            // Initialize block 1
            experimentData.blocks.push({
                blockId: 'block_1',
                startTime: new Date().toISOString(),
                trials: []
            });
            
            runTrial();
        }
        
        function runTrial() {
            if (experimentData.currentTrial >= experimentData.totalTrials) {
                endExperiment();
                return;
            }
            
            // Generate random trial (50/50 go/no-go)
            const isGoTrial = Math.random() < 0.5;
            const trial = generateTrial(isGoTrial, experimentData.currentTrial + 1);
            
            // Show fixation cross
            document.getElementById('fixation').style.display = 'block';
            document.getElementById('stimuli-container').style.display = 'none';
            
            // After blank duration, show stimuli
            setTimeout(() => {
                showStimuli(trial);
            }, settings.blankDuration);
        }
        
        function generateTrial(isGoTrial, trialNumber) {
            const quadrants = ['upper_left', 'upper_right', 'lower_left', 'lower_right'];
            const targetQuadrant = isGoTrial ? quadrants[Math.floor(Math.random() * quadrants.length)] : null;
            
            // Get current block configuration
            const currentBlockConfig = blockConfig[`block${experimentData.currentBlock}`];
            const distractorGroup = currentBlockConfig.distractorGroup;
            const targetGroup = currentBlockConfig.targetGroup;
            
            const stimuli = quadrants.map(quadrant => {
                const isTarget = (quadrant === targetQuadrant);
                const stimulusGroup = isTarget ? targetGroup : distractorGroup;
                const stimulusFile = getRandomStimulus(stimulusGroup);
                
                return {
                    quadrant: quadrant,
                    group: stimulusGroup,
                    isTarget: isTarget,
                    stimulusFile: stimulusFile
                };
            });
            
            return {
                trialId: `${isGoTrial ? 'go' : 'no_go'}_trial_${trialNumber}`,
                trialType: isGoTrial ? 'go' : 'no_go',
                stimuli: stimuli,
                distractorGroup: distractorGroup,
                targetGroup: targetGroup,
                targetQuadrant: targetQuadrant,
                startTime: new Date().toISOString()
            };
        }
        
        function showStimuli(trial) {
            document.getElementById('fixation').style.display = 'none';
            document.getElementById('stimuli-container').style.display = 'block';
            
            // Clear previous stimuli
            const container = document.getElementById('stimuli-container');
            const existingStimuli = container.querySelectorAll('.stimulus');
            existingStimuli.forEach(stimulus => stimulus.remove());
            
            // Add new stimuli
            trial.stimuli.forEach(stimulus => {
                const center = settings.quadrantCenters[stimulus.quadrant];
                // Only vertical jitter: ±50 pixels
                const jitterY = (Math.random() - 0.5) * 2 * settings.jitterRange;
                const x = center.x;
                const y = center.y + jitterY;
                
                const stimulusElement = document.createElement('div');
                stimulusElement.className = 'stimulus';
                stimulusElement.style.left = x + 'px';
                stimulusElement.style.top = y + 'px';
                
                if (stimulus.stimulusFile) {
                    // Use PNG image
                    const img = document.createElement('img');
                    img.src = stimulus.stimulusFile;
                    img.style.width = settings.stimulusWidth + 'px';
                    img.style.height = 'auto'; // Scale height proportionally
                    img.style.objectFit = 'contain';
                    stimulusElement.appendChild(img);
                } else {
                    // Fallback to circle
                    stimulusElement.style.width = settings.stimulusWidth + 'px';
                    stimulusElement.style.height = settings.stimulusWidth + 'px';
                    stimulusElement.style.borderRadius = '50%';
                    stimulusElement.style.border = '2px solid #333';
                    stimulusElement.style.backgroundColor = stimulus.isTarget ? 'red' : 'black';
                }
                
                container.appendChild(stimulusElement);
            });
            
            // Record when stimuli appear for reaction time calculation
            const stimulusStartTime = new Date();
            
            // Set up response handling
            let responded = false;
            const responseHandler = (event) => {
                if (event.code === 'Space' && !responded) {
                    responded = true;
                    const reactionTime = new Date() - stimulusStartTime;
                    recordResponse(trial, 'space', reactionTime);
                    document.removeEventListener('keydown', responseHandler);
                    
                    // Immediately advance to next trial (no delay)
                    experimentData.currentTrial++;
                    runTrial();
                }
            };
            
            document.addEventListener('keydown', responseHandler);
            
            // Auto-advance after stimulus duration if no response
            setTimeout(() => {
                if (!responded) {
                    recordResponse(trial, null, settings.stimulusDuration);
                    document.removeEventListener('keydown', responseHandler);
                    experimentData.currentTrial++;
                    runTrial();
                }
            }, settings.stimulusDuration);
        }
        
        function recordResponse(trial, response, responseTime) {
            const isGoTrial = trial.trialType === 'go';
            const correctResponse = isGoTrial ? 'space' : null;
            let accuracy = null;
            
            if (isGoTrial) {
                accuracy = response === 'space';
                
                // Record reaction time by quadrant for go trials
                if (response === 'space' && trial.targetQuadrant) {
                    experimentData.quadrantReactionTimes[trial.targetQuadrant].push(responseTime);
                }
            } else {
                accuracy = response === null;
            }
            
            const currentBlock = experimentData.blocks[experimentData.blocks.length - 1];
            currentBlock.trials.push({
                trialId: trial.trialId,
                trialType: trial.trialType,
                stimuli: trial.stimuli,
                distractorGroup: trial.distractorGroup,
                targetGroup: trial.targetGroup,
                targetQuadrant: trial.targetQuadrant,
                response: response,
                responseTime: responseTime,
                correctResponse: correctResponse,
                accuracy: accuracy,
                timestamp: new Date().toISOString()
            });
        }
        
        function endExperiment() {
            document.getElementById('trial-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            
            experimentData.endTime = new Date().toISOString();
            
            const allTrials = experimentData.blocks.flatMap(block => block.trials);
            const goTrials = allTrials.filter(t => t.trialType === 'go');
            const noGoTrials = allTrials.filter(t => t.trialType === 'no_go');
            
            const goAccuracy = goTrials.filter(t => t.accuracy).length / goTrials.length * 100;
            const noGoAccuracy = noGoTrials.filter(t => t.accuracy).length / noGoTrials.length * 100;
            
            // Calculate average reaction times by quadrant
            const quadrantAverages = {};
            Object.keys(experimentData.quadrantReactionTimes).forEach(quadrant => {
                const times = experimentData.quadrantReactionTimes[quadrant];
                if (times.length > 0) {
                    quadrantAverages[quadrant] = times.reduce((sum, time) => sum + time, 0) / times.length;
                } else {
                    quadrantAverages[quadrant] = 'No responses';
                }
            });
            
            document.getElementById('data-summary').innerHTML = `
                <h3>Data Summary</h3>
                <p>Go Trials Accuracy: ${goAccuracy.toFixed(1)}% (${goTrials.filter(t => t.accuracy).length}/${goTrials.length})</p>
                <p>No-Go Trials Accuracy: ${noGoAccuracy.toFixed(1)}% (${noGoTrials.filter(t => t.accuracy).length}/${noGoTrials.length})</p>
                <p>Total Trials: ${allTrials.length}</p>
                
                <h4>Average Reaction Times by Quadrant:</h4>
                <p><strong>Upper Left:</strong> ${typeof quadrantAverages.upper_left === 'number' ? quadrantAverages.upper_left.toFixed(1) + 'ms' : quadrantAverages.upper_left}</p>
                <p><strong>Upper Right:</strong> ${typeof quadrantAverages.upper_right === 'number' ? quadrantAverages.upper_right.toFixed(1) + 'ms' : quadrantAverages.upper_right}</p>
                <p><strong>Lower Left:</strong> ${typeof quadrantAverages.lower_left === 'number' ? quadrantAverages.lower_left.toFixed(1) + 'ms' : quadrantAverages.lower_left}</p>
                <p><strong>Lower Right:</strong> ${typeof quadrantAverages.lower_right === 'number' ? quadrantAverages.lower_right.toFixed(1) + 'ms' : quadrantAverages.lower_right}</p>
                
                <pre style="text-align: left; background: #f5f5f5; padding: 10px; border-radius: 5px; max-height: 300px; overflow-y: auto;">
${JSON.stringify(experimentData, null, 2)}
                </pre>
            `;
            
            // Save data
            localStorage.setItem('experiment_data', JSON.stringify(experimentData));
            console.log('Experiment completed. Data saved locally:', experimentData);
        }
    </script>
</body>
</html>
